<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <title>C&#43;&#43;的指针 - 欢迎来到Sugar的博客小站</title><meta name="author" content="Sugar">
<meta name="author-link" content="https://github.com/Sugar-27">
<meta name="description" content="" />
<meta name="keywords" content="C&#43;&#43;语法" /><meta itemprop="name" content="C&#43;&#43;的指针">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2022-08-27T18:53:47+08:00" />
<meta itemprop="dateModified" content="2022-08-27T18:53:47+08:00" />
<meta itemprop="wordCount" content="8056"><meta itemprop="image" content="http://sugar-27.github.io/logo.png"/>
<meta itemprop="keywords" content="C&#43;&#43;语法," /><meta property="og:title" content="C&#43;&#43;的指针" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://sugar-27.github.io/posts/c&#43;&#43;%E7%9A%84%E6%8C%87%E9%92%88/" /><meta property="og:image" content="http://sugar-27.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-27T18:53:47+08:00" />
<meta property="article:modified_time" content="2022-08-27T18:53:47+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://sugar-27.github.io/logo.png"/>

<meta name="twitter:title" content="C&#43;&#43;的指针"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="欢迎来到Sugar的博客小站">
<meta name="apple-mobile-web-app-title" content="欢迎来到Sugar的博客小站"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://sugar-27.github.io/posts/c&#43;&#43;%E7%9A%84%E6%8C%87%E9%92%88/" /><link rel="prev" href="http://sugar-27.github.io/posts/ios-uitableview%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" /><link rel="next" href="http://sugar-27.github.io/posts/linux%E4%B8%AD%E7%9A%84%E4%BF%A1%E5%8F%B7/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "C++的指针",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/sugar-27.github.io\/posts\/c\u002b\u002b%E7%9A%84%E6%8C%87%E9%92%88\/"
    },"image": ["http:\/\/sugar-27.github.io\/icon-512.png"],"genre": "posts","keywords": "C\u002b\u002b语法","wordcount":  8056 ,
    "url": "http:\/\/sugar-27.github.io\/posts\/c\u002b\u002b%E7%9A%84%E6%8C%87%E9%92%88\/","datePublished": "2022-08-27T18:53:47+08:00","dateModified": "2022-08-27T18:53:47+08:00","publisher": {
      "@type": "Organization",
      "name": "Sugar"},"author": {
        "@type": "Person",
        "name": "Sugar"
      },"description": ""
  }
  </script></head>
  <body header-desktop="sticky" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script><div class="wrapper"><header class="desktop" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="欢迎来到Sugar的博客小站"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/logo.png"
    data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x"
    data-sizes="auto"
    alt="欢迎来到Sugar的博客小站"
    title="欢迎来到Sugar的博客小站" /><span class="header-title-text">Sugar的博客小站</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li
              class="menu-item"
              
            >
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="欢迎来到Sugar的博客小站"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/logo.png"
    data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x"
    data-sizes="auto"
    alt="/logo.png"
    title="/logo.png" /><span class="header-title-text">Sugar的博客小站</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li
              class="menu-item"
            ><a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw"></i>
        </li></ul>
    </nav>
  </div>
</header>
<div class="search-dropdown desktop">
  <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
  <div id="search-dropdown-mobile"></div>
</div>
<main class="container" page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录 <i class="toc-icon fa-solid fa-angle-down fa-fw"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    
  </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">C&#43;&#43;的指针</h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a
  href="https://github.com/Sugar-27"
  
    title="作者"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer author"
  
  
    class="author"
  
  
><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="https://cn.gravatar.com/userimage/222788042/d8c06db706bb351ac77574ee6b8112d0.jpg?size=200"
    data-srcset="https://cn.gravatar.com/userimage/222788042/d8c06db706bb351ac77574ee6b8112d0.jpg?size=200, https://cn.gravatar.com/userimage/222788042/d8c06db706bb351ac77574ee6b8112d0.jpg?size=200 1.5x, https://cn.gravatar.com/userimage/222788042/d8c06db706bb351ac77574ee6b8112d0.jpg?size=200 2x"
    data-sizes="auto"
    alt="Sugar"
    title="Sugar" />&nbsp;Sugar</a></span>
          <span class="post-category">收录于 <a href="/categories/c/c++/"><i class="fa-regular fa-folder fa-fw"></i>&nbsp;C/C++</a></span></div>
      <div class="post-meta-line"><span title=2022-08-27&#32;18:53:47>
            <i class="fa-regular fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-08-27" >2022-08-27</time>
          </span>&nbsp;<i class="fa-solid fa-pencil-alt fa-fw"></i>&nbsp;约 8056 字&nbsp;
        <i class="fa-regular fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;</div>
    </div><div class="details toc" id="toc-static" kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#指针的概念">指针的概念</a>
      <ul>
        <li><a href="#c中内存单元内容与地址">C++中内存单元内容与地址</a></li>
        <li><a href="#指针的定义与间接访问操作">指针的定义与间接访问操作</a></li>
      </ul>
    </li>
    <li><a href="#左值与右值">左值与右值</a>
      <ul>
        <li><a href="#概念">概念</a></li>
        <li><a href="#具体分析">具体分析</a></li>
      </ul>
    </li>
    <li><a href="#c中的指针">C中的指针</a>
      <ul>
        <li><a href="#一般类型的指针t">一般类型的指针<code>T*</code></a></li>
        <li><a href="#指针数组">指针数组</a></li>
        <li><a href="#数组指针">数组指针</a></li>
        <li><a href="#const与指针">const与指针</a></li>
        <li><a href="#指向指针的指针">指向指针的指针</a></li>
        <li><a href="#野指针与悬空指针">野指针与悬空指针</a></li>
      </ul>
    </li>
    <li><a href="#c的资源管理方式raii">C++的资源管理方式——RAII</a>
      <ul>
        <li><a href="#raiiresource-acquisition-is-initialization">RAII(Resource Acquisition Is Initialization):</a></li>
        <li><a href="#内存泄漏">内存泄漏</a></li>
      </ul>
    </li>
    <li><a href="#智能指针">智能指针</a>
      <ul>
        <li><a href="#比普通指针更安全的解决方案">比普通指针更安全的解决方案</a></li>
        <li><a href="#c中的智能指针">C++中的智能指针</a></li>
        <li><a href="#auto_ptr">auto_ptr</a></li>
        <li><a href="#unique_ptr">unique_ptr</a></li>
        <li><a href="#shared_ptr与weak_ptr">shared_ptr与weak_ptr</a></li>
      </ul>
    </li>
    <li><a href="#c的引用">C++的引用</a>
      <ul>
        <li><a href="#引用是什么">引用是什么</a></li>
        <li><a href="#引用的基本使用">引用的基本使用</a></li>
        <li><a href="#最常用的使用场景">最常用的使用场景</a></li>
        <li><a href="#两个问题的思考">两个问题的思考</a>
          <ul>
            <li><a href="#有了指针为什么还需要引用">有了指针为什么还需要引用</a></li>
            <li><a href="#有了引用为什么还需要指针">有了引用为什么还需要指针</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div
      class="content"
      id="content"
      
      
    ><h1 id="c的指针">C++的指针</h1>
<h2 id="指针的概念">指针的概念</h2>
<h3 id="c中内存单元内容与地址">C++中内存单元内容与地址</h3>
<ul>
<li>内存由很多内存单元组成，这些内存单元用于存放各种类型的数据</li>
<li>计算机对内存中的每个内存单元都进行了编号，这个编号就称为内存地址，地址决定了内存单元在内存中的位置</li>
<li>记住这些单元地址不方便，于是C++的编译器就允许通过设置变量的方式来访问这些内存地址，而这个变量就是指针</li>
</ul>
<p>举例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span> <span class="c1">// 此时ptr存储的变量内容就是a的地址，通过ptr可以间接访问a
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="指针的定义与间接访问操作">指针的定义与间接访问操作</h3>
<ul>
<li>指针定义的基本形式：指针本身就是一个变量，只不过它存储的内容是地址。对于类型<code>T</code>，<code>T* ptr</code> 就是在定义一个指向类型为<code>T</code>的指针<code>ptr</code>，这个<code>ptr</code>就可以存储「类型为<code>T</code>的变量的地址」</li>
<li>通过一个指针访问它所指向地址的过程称为间接访问或者引用指针，而这个用于执行间接访问的操作符就是单目运算符<code>*</code>
例如：<code>std::cout &lt;&lt; *ptr &lt;&lt; std::endl;</code>就可以打印出来<code>ptr</code>所指向的值（使用<code>std::cout &lt;&lt; ptr &lt;&lt; std::endl;</code>可以打印出来ptr存储的地址）</li>
</ul>
<h2 id="左值与右值">左值与右值</h2>
<p>一个小案例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义一个数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">str1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;Hello, world&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">str2</span> <span class="o">=</span> <span class="s">&#34;Hello, world&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">str2</span> <span class="o">=</span> <span class="n">str1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// str1 = str2; 	// 这一行如果不注释会报错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面这个小demo中，str2可以赋值为str1，但是str1并不可以被str2赋值，换言之指针变量的值允许改变而数组变量的值不可以改变，虽然在使用的时候str1和str2区别不大，但在赋值上他俩截然不同，这就是左值与右值。</p>
<h3 id="概念">概念</h3>
<p>这里不深究原理，简单从工程的角度上来解读一下左值与右值</p>
<p>左值即可以放到赋值运算符<code>=</code>左边的值，包括设定好的变量、指针等（左值也可以放到<code>=</code>右边）</p>
<p>右值即只能放到赋值运算符<code>=</code>右边的值，它一般是一个数据的本身，不能取到本身的地址，包括字面值常量、数值常量等（右值只能放到<code>=</code>右边）</p>
<h3 id="具体分析">具体分析</h3>
<ul>
<li>左值最常见的情况如函数和数据成员的名字</li>
<li>右值是没有标识符、不可以取地址的表达式，一般也称为临时对象</li>
<li>比如<code>a = b + c</code>，可以通过<code>&amp;a</code>来取a的地址但不可以<code>&amp;(b + c)</code>来取(b + c)的地址，这里的a就是左值，而(b + c)就是右值</li>
</ul>
<h2 id="c中的指针">C中的指针</h2>
<p>这里先简单引入一下C中的指针以及其特点</p>
<h3 id="一般类型的指针t">一般类型的指针<code>T*</code></h3>
<p>这里的<code>T</code>指的是任何一种类型，比如<code>int*</code>指的就是<code>int</code>类型的指针，它指向一个相应类型的对象，存储的内容就是其地址</p>
<blockquote>
<p>这个类型也包括函数类型，当对应的类型是函数时，它也就被称为函数指针</p>
</blockquote>
<h3 id="指针数组">指针数组</h3>
<p>指针数组首先是一个数组，其里面存储的变量是指针，一般的数组定义时如<code>int a[]</code>，对于指针类型也一样，定义一组指针数组形如<code>T* a[]</code></p>
<h3 id="数组指针">数组指针</h3>
<p>数组指针与指针数组是相反的概念，数组指针首先是一个指针，只是这个指针指向的类型是数组，比如<code>T(*b)[]</code></p>
<blockquote>
<p>其实可以理解为：<code>[]</code>的优先级比<code>*</code>高</p>
</blockquote>
<h3 id="const与指针">const与指针</h3>
<p>const与指针真的爱恨纠缠，const和pointer的前后顺序不同就会导致其表达的意思不同，总体上分为两类：</p>
<ul>
<li>const pointer：常量指针，形式为<code>const T* ptr</code>，常量指针表示的是这个指针指向的是一个常量，即指向的对象本身不可以修改，但指针可以更换地址（也即可以更换指向的对象）</li>
<li>pointer to const：指针常量，形式为<code>T* const ptr</code>，指针常量表示的是这个指针是一个常量，即指针所存储的地址不可以改变（指向的对象不可以变更），但指向的对象本身可以更改其值</li>
</ul>
<blockquote>
<p>已经在上面的介绍中透露出来了一种速记方式，即按照<code>const</code>与<code>*</code>出现的顺序来判断，<code>const</code>在前就先念常量，<code>*</code>在前就先念指针，同时按照顺序去理解，常量指针——类似于「字符串指针」、「数组指针」即它指向的是常量；而指针常量——则直接按照顺序读即可「指针是常量」。</p>
<p>这里个人推荐尽可能避免使用指针常量，因为它本身确实有些反人类，在代码中会很容易降低可读性，除非必须使用，否则应当避免</p>
</blockquote>
<h3 id="指向指针的指针">指向指针的指针</h3>
<p>即一个指针，它存储的地址所对应的对象还是一个地址，形如<code>T** ptr</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span><span class="o">**</span> <span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="野指针与悬空指针">野指针与悬空指针</h3>
<ol>
<li>野指针是未初始化的指针，这种指针内存储的地址值是未定义的，会存在两种情况：
<ul>
<li>访问的地址是无效的：会报错，进程会终止</li>
<li>访问的地址是有效的：但并不知道访问的是哪里的地址，造成程序混乱</li>
<li>解决办法：只要定义一个指针就要对其进行初始化，比如直接赋值为<code>nullptr</code>，在具体使用时再对其赋实际的地址</li>
</ul>
</li>
<li>悬空指针是指针所指的对象已被释放掉的指针，对其访问也会存在与野指针相似的两种情况
<ul>
<li>解决办法：当析构对象的时候，将指向其的指针设置为<code>nullptr</code>，当然这样子并不一定总是可靠，最好还是通过RAII的方式来管理指针，当析构函数执行时自动执行设置为<code>nullptr</code>的行为，比如使用智能指针</li>
</ul>
</li>
</ol>
<blockquote>
<p>⚠️：这里给到的提示就是当用指针进行间接访问时，一定要非常非常小心，确保其地址有意义再去使用</p>
<p>❗️：另外，历史代码中一般使用<code>NULL</code>来表示空指针，但这个本质上是0，是一个数字，仍然存在着一定的问题，因此在C++11中推出了<code>nullptr</code>表示空指针，<code>nullptr</code>无任何实际含义，只表示指针为空，现代C++程序应尽可能使用<code>nullptr</code></p>
</blockquote>
<h2 id="c的资源管理方式raii">C++的资源管理方式——RAII</h2>
<h3 id="raiiresource-acquisition-is-initialization">RAII(Resource Acquisition Is Initialization):</h3>
<ul>
<li>C++所特有的资源管理方式（部分语言如D、Rust也采纳了RAII），主流语言中唯一一个依赖RAII来做资源管理的</li>
<li>RAII依托于栈和析构函数，来对所有的资源——包括堆内存进行管理。通过使用RAII，使得C++不需要类似于JAVA的垃圾回收机制也可以有效的管理内存分配释放问题。</li>
<li>RAII比较成熟的代表：智能指针（unique_ptr、shared_ptr）</li>
</ul>
<h3 id="内存泄漏">内存泄漏</h3>
<ul>
<li>
<p>什么是内存泄漏：</p>
<p>程序中通过动态分配（<code>new</code>）的堆内存由于某种原因导致程序未释放或无法释放相应资源而导致的内存资源浪费的情况称为内存泄漏，内存泄漏会导致程序运行期间可用内存的减少，严重者可以导致程序的运行速度减缓甚至崩溃</p>
</li>
<li>
<p>发生原因和排查方法：</p>
<ul>
<li>内存泄漏主要发生在堆内存分配方式中，即“配置了内存后，所有指向该内存的指针都遗失了”，没有垃圾回收机制时这块内存就再也无法归还给系统</li>
<li>内存泄漏属于程序运行的问题，无法在编译期间排查，只能通过代码检查以及运行期间内存检测工具进行诊断和判别</li>
</ul>
</li>
<li>
<p>解决办法：通过RAII对内存进行管理，一个类构造的时候进行内存申请，在析构的时候进行内存释放，由于一个变量有其作用域，当离开作用域范围时会自动调用析构函数，也就会自动进行内存释放了（典型的做法是使用智能指针来对其进行管理）</p>
</li>
</ul>
<h2 id="智能指针">智能指针</h2>
<h3 id="比普通指针更安全的解决方案">比普通指针更安全的解决方案</h3>
<p>之前介绍了普通指针可能会出现的问题，对于这些问题，现代C++一般有两种典型方案：</p>
<ol>
<li>使用更安全的指针——智能指针</li>
<li>不使用指针，用更安全的方式——使用引用的方式</li>
</ol>
<h3 id="c中的智能指针">C++中的智能指针</h3>
<p>C++目前一共推出了共四种智能指针，分别是<code>unique_ptr</code>、<code>shared_ptr</code>、<code>weak_ptr</code>以及已经在C++11中被弃用（deprecated）的<code>auto_ptr</code>（在C++17中已经正式被删除）</p>
<h3 id="auto_ptr">auto_ptr</h3>
<p>首先来看一下<code>auto_ptr</code>，它是最早的智能指针，可以比较容易的看出来智能指针的作用与思想，后续的智能指针本质上都是将<code>auto_ptr</code>进行完善与延伸。</p>
<ul>
<li>
<p>基本特性：首先<code>auto_ptr</code>使用方法跟指针一样，内部也相当于存储着一个地址，但对于<code>new expression</code>获得的对象不需要像普通的<code>new</code>的对象一样<code>delete</code>去销毁对象而是在<code>auto_ptr</code>对象销毁时，它所管理的对象也会被自动<code>delete</code>掉，这里还是比较抽象的，举一个简单的例子：在一个函数片段中如果需要<code>new</code>一个对象，那么使用普通指针和智能指针的表现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// 普通指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">xxx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">test_class</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">test_class</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">delete</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 智能指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">xxx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">test_class</span><span class="o">&gt;</span> <span class="n">ptr2</span> <span class="p">(</span><span class="k">new</span> <span class="n">test_class</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出来，当使用普通指针的时候，在离开作用域之前需要先delete，而使用智能指针则不用，这是因为智能指针离开作用域时会被销毁，而智能指针被销毁时会自动delete掉它的对象。</p>
</li>
<li>
<p>所有权转移：如果将<code>auto_ptr</code>传递给另外的智能指针，原来的指针就不再拥有这个对象了，在拷贝/赋值的过程中，会剥夺指针对原对象的内存都控制权，控制权转交给新对象，再将原对象的指针置为<code>nullptr</code>，为了更好展示这个特点以及其可能存在的隐患，看一下下面这个例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">explicit</span> <span class="n">Test</span><span class="p">(</span><span class="n">string</span> <span class="n">str</span><span class="p">)</span> <span class="o">:</span> <span class="n">str</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">str</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;构造成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">Test</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;析构成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">print</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span> <span class="n">strs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;C&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;C++&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;Java&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------first loop------&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">str_ptr</span> <span class="p">:</span> <span class="n">strs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_ptr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------second loop------&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">str_ptr</span> <span class="p">:</span> <span class="n">strs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_ptr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;运行结束</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">构造成功
</span></span><span class="line"><span class="cl">构造成功
</span></span><span class="line"><span class="cl">构造成功
</span></span><span class="line"><span class="cl">------first loop------
</span></span><span class="line"><span class="cl">C
</span></span><span class="line"><span class="cl">C++
</span></span><span class="line"><span class="cl">Java
</span></span><span class="line"><span class="cl">C++
</span></span><span class="line"><span class="cl">------second loop------
</span></span><span class="line"><span class="cl">C
</span></span><span class="line"><span class="cl">析构成功
</span></span><span class="line"><span class="cl">C++
</span></span><span class="line"><span class="cl">析构成功
</span></span><span class="line"><span class="cl">Java
</span></span><span class="line"><span class="cl">析构成功
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">进程已结束,退出代码139 <span class="o">(</span>interrupted by signal 11: SIGSEGV<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，first loop可以打印出<code>C++</code>，而second loop并没有能够打印出<code>C++</code>，这个就是因为所有权的转移，第一个循环中使用的是引用的方式，因此并没有发生所有权的转移，因此循环结束再次访问没有问题，而第二个循环使用的是值拷贝的方式，这就导致了每一次使用都会使得之前的<code>auto_ptr</code>损失掉自己的所有权，而每一轮循环又会因为这个问题导致<code>new</code>的对象被直接释放掉，进而在第二次循环结束的时候再去访问这个指针，导致了crash被信号中断了，这就意味着<code>auto_ptr</code>其实并不安全。</p>
</li>
</ul>
<h3 id="unique_ptr">unique_ptr</h3>
<p>在刚刚的<code>auto_ptr</code>中，智能指针与对象有着强耦合关系，如果出现了拷贝智能指针就很有可能会出现之前所讲述的问题，并不想释放掉这个元素但在使用过程中很可能在没有察觉的过程中就完成了释放，导致后续程序错误。为了改进<code>auto_ptr</code>也就提出了<code>unique_ptr</code>。</p>
<ul>
<li>
<p><code>unique_ptr</code>的所有权是专属所有权，所以unique_ptr管理的内存，智能被一个对象所持有，同时不支持拷贝和赋值</p>
</li>
<li>
<p>移动语义：<code>unique_ptr</code>禁止了拷贝语义，但有时也需要能够转移所有权，于是提供了移动语义，也即可以使用<code>std::move()</code>语句进行转移所有权。接下来具体看一下，首先同样是之前的例子，将<code>auto_ptr</code>更换为<code>unique_ptr</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">explicit</span> <span class="n">Test</span><span class="p">(</span><span class="n">string</span> <span class="n">str</span><span class="p">)</span> <span class="o">:</span> <span class="n">str</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">str</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;构造成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">Test</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;析构成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">print</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span> <span class="n">strs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;C&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;C++&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;Java&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------first loop------&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">str_ptr</span> <span class="p">:</span> <span class="n">strs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_ptr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------second loop------&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">str_ptr</span> <span class="p">:</span> <span class="n">strs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_ptr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;运行结束</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果这个时候进行编译，会发现程序编译会报错，报错内容在<code>for (auto str_ptr : strs)</code>，报错信息为：<code>Call to implicitly-deleted copy constructor of 'unique_ptr&lt;Test&gt;'</code>，也就是说<code>unique_ptr</code>不支持通过拷贝来构造，通过这种方式就不可以继续使用之前的方式来进行访问了，如果确定要移动走所有权，那么就要显示的使用<code>std::move()</code>进行转移，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">explicit</span> <span class="n">Test</span><span class="p">(</span><span class="n">string</span> <span class="n">str</span><span class="p">)</span> <span class="o">:</span> <span class="n">str</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">str</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;构造成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">Test</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;析构成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">print</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">string</span> <span class="n">str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span> <span class="n">strs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;C&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;C++&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">Test</span><span class="p">(</span><span class="s">&#34;Java&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------first loop------&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">str_ptr</span> <span class="p">:</span> <span class="n">strs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_ptr</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;------second loop------&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">str_ptr</span> <span class="p">:</span> <span class="n">strs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">str_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">strs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;运行结束</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过明确的移动语义移动走所有权，然后进行使用，析构，当使用明确的移动语义时就可以避免程序员的失误导致对象被释放。另外，<code>unique_ptr</code>也支持了与<code>nullptr</code>进行比较，这一点也是<code>auto_ptr</code>没有的，相比之下也就更安全，另外，在C++11中更加提倡使用工厂模式的工厂函数来生产智能指针，因此在第一段生成<code>unique_ptr</code>的函数那里，将代码更改为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span> <span class="n">strs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;C&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;C++&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Test</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;Java&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>常用的<code>unique_ptr</code>方法：</p>
<ul>
<li><code>ptr.get()</code>：用于获取原始指针，因为历史的包袱问题，很多时候C++并不能完全使用智能指针，对于需要使用<code>C</code>指针的时候通过<code>get()</code>方法就可以使用普通指针了</li>
</ul>
</li>
</ul>
<h3 id="shared_ptr与weak_ptr">shared_ptr与weak_ptr</h3>
<p>不论是<code>auto_ptr</code>还是<code>unique_ptr</code>，本质上其实都是一样的，都只允许一个智能指针来访问一个对象，而不允许多个智能指针来访问同一个对象，但如果想像普通指针一样去使用智能指针，那么就必须允许多个智能指针来访问同一个对象，因此也就有了<code>shared_ptr</code></p>
<ul>
<li>
<p>解决方法：通过「引用计数」机制使得多个智能指针可以访问同一个对象，引用计数就是当有一个智能指针指向该对象时，引用计数加1，当一个智能对象被销毁时引用计数减1，当引用计数减小到0时会释放对象资源然后执行对应的析构函数。（当然引入「引用计数」会存在一定的额外开销，但相比较于它的优势可以忽略不计，除非非常明确不使用<code>shared_ptr</code>会更好，否则使用<code>shared_ptr</code>一定不是一件坏事情）</p>
</li>
<li>
<p>引用计数的问题——循环引用：</p>
<ul>
<li>
<p>起因：如下图所示，两个类中，A中含有类型B的<code>shared_ptr</code>，B中含有类型A的<code>shared_ptr</code>
<img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856997.png"
    data-srcset="https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856997.png, https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856997.png 1.5x, https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856997.png 2x"
    data-sizes="auto"
    alt="https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856997.png"
    title="image-20220827175131397" /></p>
<p>这时使用分别<code>new</code>一个类型为A和B的对象A和对象B，并使用ptr A指向对象A，ptrB指向对象B，此时对象A的指针指向对象B，此时对象B的指针指向对象A。当ptrA使用结束时，ptrA释放，对象A的引用计数-1，但因为对象B仍然持有对象A的智能指针，所以引用计数大于0，也就不会析构对象A；接下来ptrB也使用结束，对象B的引用计数-1，但因为之前对象A并没有被析构，因此对象B的引用计数也仍然大于0，因此对象B也没有被析构，这种情况下，ptrA和ptrB都被释放了，但对象A和对象B都没有被析构，同时也没有其他指针指向他们，换言之，已经发生了内存泄漏，因为对象A和对象B不可能再被析构。</p>
</li>
<li>
<p>解决方法：使用<code>weak_ptr</code></p>
<ul>
<li><code>weak_ptr</code>被设计用来和<code>shared_ptr</code>一起使用，它工作在观察者模式，对于它指向的对象是一种弱引用，也就是说它可以获得资源的观测权，像旁观者一样观察资源的使用情况，但是弱引用就代表着它不会增加<code>shared_ptr</code>的引用计数，当被观察的<code>shared_ptr</code>失效之后，相应的<code>weak_ptr</code>也就失效了，如下图所示，虚线代表观察，不增加引用计数<img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856075.png"
    data-srcset="https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856075.png, https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856075.png 1.5x, https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856075.png 2x"
    data-sizes="auto"
    alt="https://sugar-pictures.oss-cn-shanghai.aliyuncs.com/202208271856075.png"
    title="image-20220827175241365" /></li>
</ul>
</li>
<li>
<p>代码示例：</p>
<ul>
<li>
<p>不使用<code>weak_ptr</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A构造完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">A</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A析构完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">B</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">B</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B构造完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">B</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B析构完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrA</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrB</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptrA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptrA</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptrB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时，ptrA和ptrB出现了相互引用，程序结果为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">A构造完成
</span></span><span class="line"><span class="cl">B构造完成
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出来并没有发生析构，此时如果将最后一行代码去掉，即ptrA的ptr为nullptr</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A构造完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">A</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A析构完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">B</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">B</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B构造完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">B</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B析构完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrA</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrB</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptrA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//    ptrA-&gt;ptr = ptrB;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时结果为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">A构造完成
</span></span><span class="line"><span class="cl">B构造完成
</span></span><span class="line"><span class="cl">B析构完成
</span></span><span class="line"><span class="cl">A析构完成
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以推断出来，只要一方不持有另一方的指针，那么就可以正常析构，而这也就是<code>weak_ptr</code>的基本原理，同时再赋予其观察者的身份，使得其可以正常使用相对应的指针。</p>
</li>
<li>
<p>使用<code>weak_ptr</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A构造完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">A</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;A析构完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">B</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">B</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">:</span> <span class="n">ptr</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B构造完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">B</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;B析构完成</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrA</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrB</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptrA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptrA</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptrB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里只需要将B中的ptr指针更改为<code>weak_ptr</code>类型即可以完成实验，实验结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">A</span><span class="err">构造完成</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span><span class="err">构造完成</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span><span class="err">析构完成</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span><span class="err">析构完成</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有两个地方要注意：</p>
<ol>
<li>类型B的构造函数其实是运用了隐式转换，另外一方面也可以理解为<code>weak_ptr</code>是通过<code>shared_ptr</code>构造的，它不可以由普通指针构造，要牢记它是一个<code>shared_ptr</code>的观察者</li>
<li>这里实验结果的析构顺序和之前将A的ptr置空的析构顺序是相反的，这里是因为置空时的ptrA被释放时，B中还持有A的智能指针，也就是说引用计数不为0所以一定是先析构B再析构A；而使用<code>weak_ptr</code>时正好相反，B中相当于没持有A的指针而A中持有了B的<code>shared_ptr</code>，所以一定是先析构A再析构B</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>shared_ptr</code>常用函数：</p>
<ul>
<li>
<p><code>ptr.use_count()</code>：返回<code>shared_ptr</code>当前指向对象的引用计数，还是刚刚的例子，我们来看一下使用<code>weak_ptr</code>和不使用<code>weak_ptr</code>在引用计数上的区别：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrA</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrB</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptrA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptrA</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ptrB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptrA</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>不使用<code>weak_ptr</code>执行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">A构造完成
</span></span><span class="line"><span class="cl">B构造完成
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl">A析构完成
</span></span><span class="line"><span class="cl">B析构完成
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用<code>weak_ptr</code>执行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">A构造完成
</span></span><span class="line"><span class="cl">B构造完成
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl">A析构完成
</span></span><span class="line"><span class="cl">B析构完成
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p><code>shared_ptr</code>的<code>move</code>语义：对<code>shared_ptr</code>进行<code>std::move()</code>会将这个智能指针的所有内容转移给新指针，同时原指针会被置为<code>nullptr</code></p>
<p>示例代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptrA</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptrA</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">ptr2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">ptrA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptrA</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptr2</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ptrA</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;ptrA已经被置为nullptr&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">A构造完成
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl">ptrA已经被置为nullptr
</span></span><span class="line"><span class="cl">A析构完成
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>shared_ptr</code>也支持<code>get()</code>方法，使用作用与<code>weak_ptr</code>相同</p>
</li>
</ul>
</li>
</ul>
<h2 id="c的引用">C++的引用</h2>
<h3 id="引用是什么">引用是什么</h3>
<p>引用就是一种特殊的指针，是一种不允许修改的指针。</p>
<ul>
<li>
<p>使用指针的坑：</p>
<ol>
<li>野指针</li>
<li>悬空指针</li>
<li>不知不觉更改了指针的值但却继续使用</li>
</ol>
</li>
<li>
<p>使用引用解决的问题：</p>
<ol>
<li>不存在空引用</li>
<li>必须初始化</li>
<li>一个引用永远指向它初始化的那个对象</li>
</ol>
</li>
</ul>
<h3 id="引用的基本使用">引用的基本使用</h3>
<p>可以认为引用就是指定变量的别名，在使用时可认为引用即是变量本身</p>
<h3 id="最常用的使用场景">最常用的使用场景</h3>
<p>输入到一个函数中，需要更改两个对象的值，比如最简单的交换值<code>swap()</code>程序:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;a: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, b: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">swap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;a: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, b: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="nl">a</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nl">b</span><span class="p">:</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="nl">a</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="nl">b</span><span class="p">:</span> <span class="mi">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="两个问题的思考">两个问题的思考</h3>
<h4 id="有了指针为什么还需要引用">有了指针为什么还需要引用</h4>
<p>JAVA只有引用，而C则只有指针，C++则支持指针和引用混合编程</p>
<p>C++之父Bjarne Stroustrup的解释是：<em>为了支持函数运算符重载</em></p>
<h4 id="有了引用为什么还需要指针">有了引用为什么还需要指针</h4>
<p>因为这是C++，一定要去兼容C语言，是一种历史遗留问题，像JAVA就可以直接舍弃C语言，因为它并不需要兼容C语言</p>
<blockquote>
<p>简单来说，个人认为指针是历史，跑不掉而且在很多场景下更灵活，而引用则更符合人的直觉，使用起来更加顺畅，所有引用的场景确实都可以通过指针实现，但引用是一种更加便捷的工具，都支持不是C++的缺点，反而是优点，而重点则在程序员们要如何去使用这两样工具</p>
</blockquote></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-08-27&#32;18:53:47>更新于 2022-08-27</span>
      </div>
      <div class="post-info-license "></div>
    </div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw"></i>&nbsp;<a href="/tags/c&#43;&#43;%E8%AF%AD%E6%B3%95/">C&#43;&#43;语法</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/ios-uitableview%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="prev" rel="prev" title="iOS-UITableView使用指南"><i class="fa-solid fa-angle-left fa-fw"></i>iOS-UITableView使用指南</a>
      <a href="/posts/linux%E4%B8%AD%E7%9A%84%E4%BF%A1%E5%8F%B7/" class="next" rel="next" title="Linux中的信号">Linux中的信号<i class="fa-solid fa-angle-right fa-fw"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright"><i class="fa-regular fa-copyright fa-fw"></i>
            <span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a
  href="https://github.com/Sugar-27"
  
  
    
    
    target="_blank"
  
  
    rel="external nofollow noopener noreffer"
  
  
  
>Sugar</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon"></i>&nbsp;<span class="run-times">网站运行中 ...</span></span></div></div>
  </footer></div><div class="widgets">
  <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
      <i class="fa-solid fa-arrow-up fa-fw"></i>
    </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
      <i class="fa-solid fa-comment fa-fw"></i>
    </a>
  </div><div id="mask"></div>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js" defer></script><script type="text/javascript" src="/lib/lunr/lunr.min.js" defer></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js" defer></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js" async defer></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/pangu/pangu.min.js" defer></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{},"enablePWA":true,"enablePangu":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"siteTime":"2022-06-10T21:30:00+08:00"};</script><script type="text/javascript" src="/js/theme.min.js" defer></script></body>
</html>
